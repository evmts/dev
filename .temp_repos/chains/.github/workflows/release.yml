name: Release and Publish

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Get package version
        id: package-version
        run: |
          VERSION=$(bun --eval "console.log(require('./package.json').version)")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Check if version already published
        run: |
          VERSION=${{ steps.package-version.outputs.version }}

          # Check if version exists on npm
          if npm view chains@$VERSION version 2>/dev/null; then
            echo "Error: Version $VERSION is already published to npm"
            echo "Please bump the version in package.json before releasing"
            exit 1
          fi

          echo "Version $VERSION is not yet published - proceeding with release"

      - name: Validate NPM Token
        run: |
          if [ -z "${{ secrets.NPM_TOKEN }}" ]; then
            echo "Error: NPM_TOKEN secret is not set"
            exit 1
          fi

          # Verify token is valid by checking npm whoami
          if ! curl -s -H "Authorization: Bearer ${{ secrets.NPM_TOKEN }}" \
               https://registry.npmjs.org/-/whoami 2>&1 | grep -q username; then
            echo "Error: NPM_TOKEN is invalid or expired"
            exit 1
          fi

          echo "NPM_TOKEN is valid"

      - name: Generate chain constants
        run: bun run generate

      - name: Check for uncommitted changes
        run: |
          if ! git diff --quiet; then
            echo "Error: Generated files have uncommitted changes"
            echo "The following files were modified during generation:"
            git diff --name-only
            echo ""
            echo "Please commit these changes before creating a release"
            exit 1
          fi
          echo "No uncommitted changes detected"

      - name: Publish to npm
        env:
          NPM_CONFIG_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: bun publish --access public

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.package-version.outputs.version }}
          gh release create "v$VERSION" \
            --title "v$VERSION" \
            --notes "## Release v$VERSION

          Published to npm: https://www.npmjs.com/package/chains/v/$VERSION

          ### Installation

          \`\`\`bash
          bun add chains@$VERSION
          \`\`\`

          ### What's Changed

          See the [commit history](https://github.com/${{ github.repository }}/commits/v$VERSION) for details.

          ðŸ¤– Generated with [GitHub Actions](https://github.com/${{ github.repository }}/actions)"
